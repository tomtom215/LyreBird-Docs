# USB Device Management

Comprehensive guide to managing USB audio devices with persistent naming and automatic detection.

---

## Overview

LyreBirdAudio provides robust USB audio device management through the `usb-audio-mapper.sh` script, which automatically detects USB devices and generates persistent device names using udev rules. This ensures that audio devices maintain consistent naming even after reboots or when USB ports change.

This guide covers:

- USB device detection and mapping
- Persistent naming with udev rules
- Dual-lookup system for device identification
- Device hotplug handling
- Testing and troubleshooting USB configurations

---

## USB Audio Mapper Script

### Purpose

The `usb-audio-mapper.sh` script automates the process of creating persistent device names for USB audio devices. Without persistent naming, USB devices may be assigned different ALSA card numbers on each boot, breaking stream configurations.

### Key Features

- **Automatic Detection:** Scans and identifies all connected USB audio devices
- **Persistent Naming:** Creates stable device names using udev rules
- **Dual-Lookup System:** Supports both friendly names and full device IDs
- **Hotplug Support:** Handles device disconnect/reconnect scenarios
- **Test Mode:** Dry-run option to preview changes before applying

---

## Basic Usage

### Generate Persistent Device Names

To detect all USB audio devices and create persistent naming rules:

```bash
sudo ./usb-audio-mapper.sh
```

This will:

1. Scan all connected USB audio devices
2. Extract vendor ID, product ID, and serial numbers
3. Generate udev rules for persistent naming
4. Write rules to `/etc/udev/rules.d/99-usb-soundcards.rules`
5. Reload udev rules to activate changes

### Test Mode (Dry Run)

To preview what the script will do without making changes:

```bash
sudo ./usb-audio-mapper.sh --test
```

**Test mode shows:**

- Detected USB audio devices
- Generated udev rule syntax
- Device identification information
- What would be written to the rules file

**Example test output:**

```text
[TEST MODE] Would create udev rules for:
  - Blue Yeti (usb-046d_0825_12345678)
  - USB Audio Device (usb-0d8c_0014_56789012)

Rules file: /etc/udev/rules.d/99-usb-soundcards.rules
```

!!! tip "Always Test First"
    Run with `--test` flag first to verify device detection before applying changes, especially on production systems.

---

## Device Naming System

### Dual-Lookup Architecture

LyreBirdAudio uses a dual-lookup system for maximum flexibility and uniqueness:

#### 1. Friendly Names

Human-readable names for common devices:

```text
Blue_Yeti
USB_Microphone
Logitech_Webcam
```

**Used for:**

- Easy device identification
- Simple configuration
- Common consumer devices

#### 2. Full Device IDs

Complete USB identification strings:

```text
usb-046d_0825_12345678
usb-0d8c_0014_56789012
```

**Format:** `usb-<VendorID>_<ProductID>_<SerialNumber>`

**Used for:**

- Guaranteed uniqueness
- Multiple identical devices
- Professional deployments
- Devices without unique friendly names

### Naming Priority

When both names exist for a device:

1. System checks friendly name first
2. Falls back to full device ID if needed
3. Both names point to the same physical device

---

## Udev Rules Configuration

### Rules File Location

**Path:** `/etc/udev/rules.d/99-usb-soundcards.rules`

### Generated Rule Format

Each detected USB audio device gets a udev rule:

```bash
SUBSYSTEM=="sound", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="0825", \
ATTR{id}="usb-046d_0825_12345678", SYMLINK+="sound/by-id/usb-046d_0825_12345678"
```

**Rule Components:**

| Component | Description |
|-----------|-------------|
| `SUBSYSTEM=="sound"` | Applies rule only to audio devices |
| `ATTRS{idVendor}` | USB vendor ID (manufacturer) |
| `ATTRS{idProduct}` | USB product ID (model) |
| `ATTRS{serial}` | Device serial number (uniqueness) |
| `SYMLINK+="..."` | Creates persistent device symlink |

### Example Rules File

```bash
# Generated by usb-audio-mapper.sh
# Last updated: 2025-11-15

# Blue Yeti Microphone
SUBSYSTEM=="sound", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="0825", \
ATTR{id}="usb-046d_0825_12345678", SYMLINK+="sound/by-id/usb-046d_0825_12345678"

# Generic USB Audio Device
SUBSYSTEM=="sound", ATTRS{idVendor}=="0d8c", ATTRS{idProduct}=="0014", \
ATTR{id}="usb-0d8c_0014_56789012", SYMLINK+="sound/by-id/usb-0d8c_0014_56789012"

# Logitech Webcam with Microphone
SUBSYSTEM=="sound", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="0825", \
ATTR{id}="usb-046d_0825_98765432", SYMLINK+="sound/by-id/usb-046d_0825_98765432"
```

---

## Device Detection Process

### How Detection Works

1. **USB Enumeration**
   - Script scans `/proc/asound/cards` for audio devices
   - Identifies USB-connected devices
   - Extracts ALSA card numbers

2. **Device Identification**
   - Reads vendor ID, product ID from sysfs
   - Retrieves serial number for uniqueness
   - Generates device ID string

3. **Rule Generation**
   - Creates udev rule for each device
   - Ensures unique symlink paths
   - Handles devices without serial numbers

4. **Rule Application**
   - Writes rules to configuration file
   - Reloads udev rules: `udevadm control --reload-rules`
   - Triggers device reprocessing: `udevadm trigger`

### Device Information Sources

The mapper script collects information from:

```text
/proc/asound/cards              # ALSA card enumeration
/sys/class/sound/card*/         # Device attributes
/sys/bus/usb/devices/           # USB device information
```

---

## Managing Multiple Devices

### Multiple Identical Devices

When using multiple identical USB audio devices (same model):

**Problem:** Friendly names would conflict

**Solution:** Full device IDs differentiate using serial numbers

**Example with 3 identical microphones:**

```bash
# Device 1
usb-046d_0825_12345678

# Device 2
usb-046d_0825_87654321

# Device 3
usb-046d_0825_11223344
```

Each device gets a unique ID despite being the same model.

!!! warning "Devices Without Serial Numbers"
    Some low-cost USB audio devices lack unique serial numbers. These devices cannot be reliably distinguished and may require manual udev rule customization based on USB port location.

### Configuration for Multiple Devices

In `/etc/mediamtx/audio-devices.conf`:

```bash
# Device 1 - Using full ID
DEVICE_usb_046d_0825_12345678_SAMPLE_RATE=48000
DEVICE_usb_046d_0825_12345678_CODEC=opus
DEVICE_usb_046d_0825_12345678_BITRATE=128k

# Device 2 - Using full ID
DEVICE_usb_046d_0825_87654321_SAMPLE_RATE=48000
DEVICE_usb_046d_0825_87654321_CODEC=opus
DEVICE_usb_046d_0825_87654321_BITRATE=128k

# Device 3 - Using full ID
DEVICE_usb_046d_0825_11223344_SAMPLE_RATE=48000
DEVICE_usb_046d_0825_11223344_CODEC=opus
DEVICE_usb_046d_0825_11223344_BITRATE=128k
```

---

## Device Hotplug Handling

### Automatic Redetection

When USB devices are unplugged and reconnected:

1. **Udev triggers** device event
2. **Symlinks are recreated** automatically
3. **Device ID remains consistent** using serial number
4. **No manual intervention** required

### Stream Recovery After Hotplug

LyreBirdAudio's stream manager automatically handles device reconnection:

```bash
# Streams will automatically recover when device reconnects
sudo ./mediamtx-stream-manager.sh monitor
```

The self-healing system detects device availability and restarts failed streams.

### Best Practices for Hotplug

1. **Avoid frequent disconnections** during active streaming
2. **Use powered USB hubs** for multiple devices to prevent power issues
3. **Monitor logs** after reconnection to verify recovery
4. **Allow stabilization time** (5-10 seconds) before expecting streams to recover

---

## Verifying Device Mapping

### Check Active Devices

List all detected USB audio devices:

```bash
cat /proc/asound/cards
```

**Example output:**

```text
 0 [PCH            ]: HDA-Intel - HDA Intel PCH
                      HDA Intel PCH at 0xf7f30000 irq 128
 1 [Yeti           ]: USB-Audio - Blue Yeti
                      Blue Microphones Blue Yeti at usb-0000:00:14.0-1
 2 [Device         ]: USB-Audio - USB Audio Device
                      Generic USB Audio Device at usb-0000:00:14.0-2
```

### Check Udev Symlinks

Verify persistent device symlinks:

```bash
ls -la /dev/snd/by-id/
```

**Example output:**

```text
lrwxrwxrwx 1 root root 12 Nov 15 10:30 usb-046d_0825_12345678 -> ../controlC1
lrwxrwxrwx 1 root root 12 Nov 15 10:31 usb-0d8c_0014_56789012 -> ../controlC2
```

### Verify Device Information

Check specific device attributes:

```bash
udevadm info --name=/dev/snd/controlC1 --attribute-walk
```

This displays detailed USB device information including vendor ID, product ID, and serial number.

---

## Updating Device Mappings

### When to Regenerate Rules

Regenerate udev rules when:

- Adding new USB audio devices
- Replacing existing devices
- USB device serial numbers change
- Moving devices between systems

### Regeneration Process

```bash
# 1. Test new configuration
sudo ./usb-audio-mapper.sh --test

# 2. Apply new rules
sudo ./usb-audio-mapper.sh

# 3. Verify device detection
ls -la /dev/snd/by-id/

# 4. Update audio configuration
sudo ./lyrebird-mic-check.sh -g --quality=normal

# 5. Restart streams
sudo ./mediamtx-stream-manager.sh restart
```

---

## Troubleshooting

### Device Not Detected

**Symptom:** USB audio device not appearing in detection

**Solutions:**

1. **Check USB connection:**
   ```bash
   lsusb | grep -i audio
   ```

2. **Verify ALSA detection:**
   ```bash
   cat /proc/asound/cards
   ```

3. **Check kernel messages:**
   ```bash
   dmesg | grep -i usb | tail -20
   ```

4. **Reload USB drivers:**
   ```bash
   sudo modprobe -r snd_usb_audio
   sudo modprobe snd_usb_audio
   ```

### Udev Rules Not Applied

**Symptom:** Rules exist but symlinks not created

**Solutions:**

1. **Reload udev rules:**
   ```bash
   sudo udevadm control --reload-rules
   sudo udevadm trigger
   ```

2. **Check rule syntax:**
   ```bash
   udevadm test /sys/class/sound/card1
   ```

3. **Verify file permissions:**
   ```bash
   ls -la /etc/udev/rules.d/99-usb-soundcards.rules
   # Should be readable by root
   ```

### Duplicate Device Names

**Symptom:** Multiple devices with same ID

**Cause:** Devices without unique serial numbers

**Solution:**

Manually create port-specific rules:

```bash
# Add to 99-usb-soundcards.rules
# Device on specific USB port
SUBSYSTEM=="sound", KERNELS=="1-1.2", ATTR{id}="usb-port-1-1-2", SYMLINK+="sound/by-id/usb-port-1-1-2"
```

### Permission Issues

**Symptom:** Cannot access device files

**Solutions:**

1. **Add user to audio group:**
   ```bash
   sudo usermod -aG audio $USER
   ```

2. **Verify device permissions:**
   ```bash
   ls -la /dev/snd/
   ```

3. **Check udev rules ownership:**
   ```bash
   sudo chown root:root /etc/udev/rules.d/99-usb-soundcards.rules
   sudo chmod 644 /etc/udev/rules.d/99-usb-soundcards.rules
   ```

### Device Drops After Boot

**Symptom:** Device works initially but disappears

**Causes:**

- USB power management
- Unstable USB connection
- Insufficient power supply

**Solutions:**

1. **Disable USB autosuspend:**
   ```bash
   echo -1 | sudo tee /sys/module/usbcore/parameters/autosuspend
   ```

2. **Use powered USB hub**

3. **Update USB firmware/drivers**

---

## Best Practices

### Production Deployments

1. **Document device assignments** - Keep records of which physical device maps to which ID
2. **Label devices physically** - Mark USB devices with their IDs for easy identification
3. **Use powered USB hubs** - Prevents power-related issues with multiple devices
4. **Test after mapping** - Always verify device detection before deploying streams
5. **Backup rules file** - Save `/etc/udev/rules.d/99-usb-soundcards.rules` to version control

### Development and Testing

1. **Use test mode first** - Always run with `--test` flag before applying changes
2. **One device at a time** - When troubleshooting, test devices individually
3. **Monitor logs** - Check system logs during device enumeration
4. **Consistent USB ports** - During testing, keep devices in same ports when possible

### Maintenance

1. **Regenerate after hardware changes** - Run mapper script whenever devices are added/removed
2. **Periodic verification** - Regularly check that symlinks match physical devices
3. **Update documentation** - Keep device mapping documentation current
4. **Monitor for conflicts** - Watch for duplicate names or missing devices

---

## Advanced Configuration

### Custom Udev Rules

For specialized requirements, manually edit udev rules:

```bash
sudo nano /etc/udev/rules.d/99-usb-soundcards.rules
```

**Custom rule examples:**

```bash
# Set device permissions
SUBSYSTEM=="sound", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="0825", \
MODE="0666", GROUP="audio"

# Create multiple symlinks for same device
SUBSYSTEM=="sound", ATTRS{idVendor}=="046d", ATTRS{idProduct}=="0825", \
ATTR{id}="blue-yeti", SYMLINK+="sound/by-id/blue-yeti", SYMLINK+="sound/by-id/primary-mic"

# Port-specific naming
SUBSYSTEM=="sound", KERNELS=="1-1.2", \
ATTR{id}="front-panel-mic", SYMLINK+="sound/by-id/front-panel-mic"
```

After editing, reload rules:

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
```

### Integration with Configuration

Link device IDs to configuration in `/etc/mediamtx/audio-devices.conf`:

```bash
# Use the exact device ID from udev rules
DEVICE_usb_046d_0825_12345678_SAMPLE_RATE=48000
DEVICE_usb_046d_0825_12345678_CODEC=opus
```

Device IDs must match the symlink names created by udev rules.

---

## Related Documentation

- [Configuration](configuration.md) - Audio encoding and streaming settings
- [Stream Management](stream-management.md) - Managing RTSP streams
- [Command Reference](../reference/command-reference.md) - All available commands
- [Troubleshooting](../advanced/troubleshooting.md) - Common problems and solutions

---

## Next Steps

<div class="grid" markdown>

<div markdown>
### Stream Management
Managing RTSP streams and playback

[Stream Management →](stream-management.md)
</div>

<div markdown>
### Configuration Guide
Audio encoding and streaming settings

[Configuration Guide →](configuration.md)
</div>

</div>
